// ==UserScript==
// @name         $Bro Configuration
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  ‰∏∫ Bro Token ÁΩëÁ´ôÊ∑ªÂä†ÈÖçÁΩÆËæìÂÖ•Ê°Ü
// @author       DarrenLuo
// @match        https://bro.charms.dev/*
// @run-at       document-start
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @connect      *
// ==/UserScript==

(function() {
    'use strict';

    console.log('üöÄ Bro Token ÈÖçÁΩÆËÑöÊú¨ÂºÄÂßãÂä†ËΩΩ...');

    // ÂàõÂª∫ÈÖçÁΩÆÈù¢Êùø
    function createConfigPanel() {
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Èù¢Êùø
        if (document.getElementById('bro-config-panel')) {
            return;
        }

        // ÂàõÂª∫‰∏ªÈù¢Êùø
        const configPanel = document.createElement('div');
        configPanel.id = 'bro-config-panel';
        configPanel.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            width: 380px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #fff;
            backdrop-filter: blur(10px);
            display: block;
        `;

        // Ê†áÈ¢ò
        const title = document.createElement('h3');
        title.textContent = 'Bro Token ÈÖçÁΩÆ';
        title.style.cssText = `
            margin: 0 0 20px 0;
            color: #ff6b35;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            border-bottom: 2px solid #ff6b35;
            padding-bottom: 10px;
        `;

        // ËæìÂÖ•Ê°ÜÂÆπÂô®
        const inputsContainer = document.createElement('div');
        inputsContainer.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 15px;
        `;

        // Prover Âú∞ÂùÄËæìÂÖ•Ê°Ü
        const proverGroup = createInputGroupWithNote(
            'Prover Âú∞ÂùÄ',
            'prover-address',
            'https://v7.charms.dev/spells/prove',
            'ÈÖçÁΩÆProverÊé•Âè£Âú∞ÂùÄÔºåÁî®‰∫éÂ§ÑÁêÜÁõ∏ÂÖ≥ËØ∑Ê±Ç'
        );

        // ÊåâÈíÆÂÆπÂô®
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        `;

        // ‰øùÂ≠òÊåâÈíÆ
        const saveBtn = document.createElement('button');
        saveBtn.textContent = '‰øùÂ≠òÈÖçÁΩÆ';
        saveBtn.style.cssText = `
            flex: 1;
            padding: 12px 20px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        `;

        // Âà∑Êñ∞ÊåâÈíÆ
        const refreshBtn = document.createElement('button');
        refreshBtn.textContent = 'Âà∑Êñ∞È°µÈù¢';
        refreshBtn.style.cssText = `
            flex: 1;
            padding: 12px 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        `;


        // ÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú
        [saveBtn, refreshBtn].forEach(btn => {
            btn.addEventListener('mouseenter', () => {
                btn.style.transform = 'translateY(-2px)';
                btn.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.transform = 'translateY(0)';
                btn.style.boxShadow = 'none';
            });
        });

        // ÁªÑË£ÖÈù¢Êùø
        inputsContainer.appendChild(proverGroup);
        buttonContainer.appendChild(saveBtn);
        buttonContainer.appendChild(refreshBtn);

        configPanel.appendChild(title);
        configPanel.appendChild(inputsContainer);
        configPanel.appendChild(buttonContainer);

        // ‰∫ã‰ª∂ÁõëÂê¨
        saveBtn.addEventListener('click', saveConfiguration);
        refreshBtn.addEventListener('click', () => window.location.reload());

        // Ê∑ªÂä†Âà∞È°µÈù¢
        document.body.appendChild(configPanel);

        // Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ
        loadConfiguration();
    }

    // ÂàõÂª∫ËæìÂÖ•ÁªÑ
    function createInputGroup(label, id, placeholder) {
        const group = document.createElement('div');
        group.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 8px;
        `;

        const labelElement = document.createElement('label');
        labelElement.textContent = label;
        labelElement.style.cssText = `
            font-size: 14px;
            font-weight: 500;
            color: #ccc;
        `;

        const input = document.createElement('input');
        input.type = 'text';
        input.id = id;
        input.placeholder = placeholder;
        input.style.cssText = `
            padding: 12px;
            border: 1px solid #444;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        `;

        input.addEventListener('focus', () => {
            input.style.borderColor = '#ff6b35';
            input.style.background = 'rgba(255, 255, 255, 0.15)';
        });

        input.addEventListener('blur', () => {
            input.style.borderColor = '#444';
            input.style.background = 'rgba(255, 255, 255, 0.1)';
        });

        group.appendChild(labelElement);
        group.appendChild(input);

        return group;
    }

    // ÂàõÂª∫Â∏¶ËØ¥ÊòéÁöÑËæìÂÖ•ÁªÑ
    function createInputGroupWithNote(label, id, placeholder, note) {
        const group = document.createElement('div');
        group.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 5px;
        `;

        const labelElement = document.createElement('label');
        labelElement.textContent = label;
        labelElement.style.cssText = `
            font-size: 12px;
            font-weight: 500;
            color: #ccc;
        `;

        const input = document.createElement('input');
        input.type = 'text';
        input.id = id;
        input.placeholder = placeholder;
        input.style.cssText = `
            padding: 10px;
            border: 1px solid #444;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        `;

        const noteElement = document.createElement('div');
        noteElement.textContent = note;
        noteElement.style.cssText = `
            font-size: 11px;
            color: #999;
            font-style: italic;
            line-height: 1.3;
            margin-top: 2px;
        `;

        input.addEventListener('focus', () => {
            input.style.borderColor = '#ff6b35';
            input.style.background = 'rgba(255, 255, 255, 0.15)';
        });

        input.addEventListener('blur', () => {
            input.style.borderColor = '#444';
            input.style.background = 'rgba(255, 255, 255, 0.1)';
        });

        group.appendChild(labelElement);
        group.appendChild(input);
        group.appendChild(noteElement);

        return group;
    }

    // ‰øùÂ≠òÈÖçÁΩÆ
    function saveConfiguration() {
        const proverAddress = document.getElementById('prover-address').value;

        const config = {
            proverAddress: proverAddress
        };

        localStorage.setItem('bro-token-config', JSON.stringify(config));

        // ÊòæÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫
        showNotification('‚úÖ ÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºÅ', 'success');
        
        // ‰øùÂ≠òÂêéÁ´ãÂç≥Ê£ÄÊµãreadyÊé•Âè£
        setTimeout(() => {
            testProverConnection();
        }, 500);
    }

    // Âä†ËΩΩÈÖçÁΩÆ
    function loadConfiguration() {
        const savedConfig = localStorage.getItem('bro-token-config');
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            document.getElementById('prover-address').value = config.proverAddress || '';
        }
    }

    // Ëé∑ÂèñÈÖçÁΩÆ
    function getConfiguration() {
        const savedConfig = localStorage.getItem('bro-token-config');
        return savedConfig ? JSON.parse(savedConfig) : {
            proverAddress: 'https://v7.charms.dev/spells/prove'
        };
    }

    // ÊòæÁ§∫ÈÄöÁü•
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.textContent = message;

        let backgroundColor;
        switch(type) {
            case 'success':
                backgroundColor = '#4CAF50';
                break;
            case 'error':
                backgroundColor = '#f44336';
                break;
            default:
                backgroundColor = '#2196F3';
        }

        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${backgroundColor};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10003;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            max-width: 300px;
            margin-bottom: 10px;
        `;

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
            style.remove();
        }, 3000);
    }

    // Êã¶Êà™Âπ∂ÈáçÂÆöÂêëproverËØ∑Ê±Ç
    function interceptProverRequests() {
        console.log('üöÄ ÂêØÂä®ProverËØ∑Ê±ÇÊã¶Êà™Âô®...');
        
        const targetProverUrl = 'https://v7.charms.dev/spells/prove';
        console.log('üéØ ÁõÆÊ†áÊã¶Êà™URL:', targetProverUrl);
        
        // Âä´ÊåÅ fetch ËØ∑Ê±Ç
        const originalFetch = unsafeWindow.fetch;
        unsafeWindow.fetch = async function(...args) {
            const url = args[0];
            
            console.log('üîç FetchËØ∑Ê±Ç:', url);

            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁõÆÊ†áproverËØ∑Ê±Ç
            if (url === targetProverUrl) {
                console.log('üéØ Êã¶Êà™Âà∞ProverËØ∑Ê±Ç (fetch):', url);
                
                const config = getConfiguration();
                const customProverUrl = config.proverAddress;
                console.log('üîÑ ÈáçÂÆöÂêëÂà∞:', customProverUrl);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÈªòËÆ§ÈÖçÁΩÆÔºåÂ¶ÇÊûúÊòØÂàôÁõ¥Êé•‰ΩøÁî®ÂéüÂßãfetch
                if (customProverUrl === targetProverUrl) {
                    console.log('‚ÑπÔ∏è ‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆÔºåÁõ¥Êé•ËØ∑Ê±ÇÂéüÂú∞ÂùÄ');
                    return await originalFetch.apply(this, args);
                }
                
                // ‰ΩøÁî®GM_xmlhttpRequestÈáçÂÆöÂêëËØ∑Ê±Ç
                return new Promise((resolve, reject) => {
                    const method = (args[1] && args[1].method) || 'GET';
                    const headers = (args[1] && args[1].headers) || {};
                    
                    GM_xmlhttpRequest({
                        method: method,
                        url: customProverUrl,
                        headers: {
                            'User-Agent': navigator.userAgent,
                            'Accept': '*/*',
                            ...headers
                        },
                        data: args[1] && args[1].body,
                        onload: function(response) {
                            console.log('‚úÖ GM_xmlhttpRequestËØ∑Ê±ÇÊàêÂäüÔºåÁä∂ÊÄÅ:', response.status);
                            
                            // ÂàõÂª∫ResponseÂØπË±°
                            const responseHeaders = new Headers();
                            Object.keys(response.responseHeaders || {}).forEach(key => {
                                responseHeaders.set(key, response.responseHeaders[key]);
                            });
                            
                            resolve(new Response(response.responseText || response.response, {
                                status: response.status,
                                statusText: response.statusText || 'OK',
                                headers: responseHeaders
                            }));
                        },
                        onerror: function(error) {
                            console.error('‚ùå GM_xmlhttpRequestËØ∑Ê±ÇÂ§±Ë¥•:', error);
                            reject(new Error(`Request failed: ${error.error || 'Unknown error'}`));
                        },
                        ontimeout: function() {
                            console.error('‚ùå GM_xmlhttpRequestËØ∑Ê±ÇË∂ÖÊó∂');
                            reject(new Error('Request timeout'));
                        }
                    });
                });
            }
            
            return await originalFetch.apply(this, args);
        };
        
        // Âä´ÊåÅ XMLHttpRequest
        const originalXHROpen = unsafeWindow.XMLHttpRequest.prototype.open;
        const originalXHRSend = unsafeWindow.XMLHttpRequest.prototype.send;
        
        unsafeWindow.XMLHttpRequest.prototype.open = function(method, url, ...args) {
            this._originalUrl = url;
            this._originalMethod = method;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁõÆÊ†áproverËØ∑Ê±Ç
            if (url === targetProverUrl) {
                console.log('üéØ Êã¶Êà™Âà∞ProverËØ∑Ê±Ç (XHR):', url);
                
                const config = getConfiguration();
                const customProverUrl = config.proverAddress;
                console.log('üîÑ ÈáçÂÆöÂêëÂà∞:', customProverUrl);
                
                // ÂØπ‰∫éXHRÔºåÊàë‰ª¨Âè™ËÉΩÈáçÂÆöÂêëURL
                if (customProverUrl !== targetProverUrl) {
                    url = customProverUrl;
                }
            }
            
            return originalXHROpen.apply(this, [method, url, ...args]);
        };
        
        unsafeWindow.XMLHttpRequest.prototype.send = function(...args) {
            return originalXHRSend.apply(this, args);
        };
        
        console.log('üîß ProverËØ∑Ê±ÇÊã¶Êà™Âô®Â∑≤ÂêØÂä®');
    }

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàõÂª∫ÈÖçÁΩÆÈù¢Êùø
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            createConfigPanel();
            interceptProverRequests();
        });
    } else {
        createConfigPanel();
        interceptProverRequests();
    }

    // ÁîüÊàêreadyÊé•Âè£Âú∞ÂùÄ
    function generateReadyUrl(proverUrl) {
        try {
            const url = new URL(proverUrl);
            // Â∞ÜË∑ØÂæÑÊõøÊç¢‰∏∫ /ready
            url.pathname = '/ready';
            return url.toString();
        } catch (e) {
            console.error('‚ùå URLËß£ÊûêÂ§±Ë¥•:', e);
            return null;
        }
    }

    // ÊµãËØïÈÖçÁΩÆÂú∞ÂùÄËøûÊé•
    function testProverConnection() {
        const config = getConfiguration();
        const proverUrl = config.proverAddress;
        
        // Ê£ÄÊü•ÊòØÂê¶ÊòØÈªòËÆ§ÈÖçÁΩÆ
        if (proverUrl === 'https://v7.charms.dev/spells/prove') {
            console.log('‚ÑπÔ∏è ‰ΩøÁî®ÈªòËÆ§ProverÂú∞ÂùÄÔºåË∑≥ËøáreadyÊ£ÄÊµã');
            return;
        }
        
        console.log('üß™ Ê£ÄÊµãProverÊúçÂä°Áä∂ÊÄÅ...');
        console.log('üéØ ProverÂú∞ÂùÄ:', proverUrl);
        
        // ÁîüÊàêÂØπÂ∫îÁöÑreadyÊé•Âè£Âú∞ÂùÄ
        const readyUrl = generateReadyUrl(proverUrl);
        if (!readyUrl) {
            console.error('‚ùå Êó†Ê≥ïÁîüÊàêreadyÊé•Âè£Âú∞ÂùÄ');
            showNotification('‚ùå ProverÂú∞ÂùÄÊ†ºÂºèÈîôËØØ', 'error');
            return;
        }
        
        console.log('üîç Ê£ÄÊµãreadyÊé•Âè£:', readyUrl);
        
        // ‰ΩøÁî®GM_xmlhttpRequestÊµãËØïreadyÊé•Âè£
        GM_xmlhttpRequest({
            method: 'GET',
            url: readyUrl,
            timeout: 10000,
            headers: {
                'User-Agent': navigator.userAgent,
                'Accept': '*/*'
            },
            onload: function(response) {
                if (response.status === 200) {
                    console.log('‚úÖ ReadyÊé•Âè£Ê£ÄÊµãÊàêÂäüÔºÅ');
                    console.log('üìä Áä∂ÊÄÅÁ†Å:', response.status);
                    console.log('üìÑ ÂìçÂ∫îÂÜÖÂÆπ:', response.responseText.substring(0, 200));
                    console.log('üåê Ê£ÄÊµãÂú∞ÂùÄ:', readyUrl);
                    
                    // ÊòæÁ§∫ÊàêÂäüÈÄöÁü•
                    showNotification(`‚úÖ ProverÊúçÂä°Ê≠£Â∏∏ (${response.status})`, 'success');
                } else {
                    console.warn('‚ö†Ô∏è ReadyÊé•Âè£ËøîÂõûÈùû200Áä∂ÊÄÅÁ†Å');
                    console.log('üìä Áä∂ÊÄÅÁ†Å:', response.status);
                    console.log('üìÑ ÂìçÂ∫îÂÜÖÂÆπ:', response.responseText.substring(0, 200));
                    
                    // ÊòæÁ§∫Ë≠¶ÂëäÈÄöÁü•
                    showNotification(`‚ö†Ô∏è ProverÊúçÂä°ÂºÇÂ∏∏ (${response.status})`, 'error');
                }
            },
            onerror: function(error) {
                console.error('‚ùå ReadyÊé•Âè£Ê£ÄÊµãÂ§±Ë¥•:', error);
                
                // ÊòæÁ§∫Â§±Ë¥•ÈÄöÁü•
                showNotification('‚ùå ProverÊúçÂä°‰∏çÂèØÁî®ÔºåËØ∑Ê£ÄÊü•ÈÖçÁΩÆ', 'error');
            },
            ontimeout: function() {
                console.error('‚è∞ ReadyÊé•Âè£Ê£ÄÊµãË∂ÖÊó∂');
                showNotification('‚è∞ ProverÊúçÂä°ÂìçÂ∫îË∂ÖÊó∂', 'error');
            }
        });
    }


    // Êö¥Èú≤ÈÖçÁΩÆÂáΩÊï∞Âà∞ÂÖ®Â±Ä
    unsafeWindow.getBroConfig = getConfiguration;
    unsafeWindow.testProverConnection = testProverConnection;

    console.log('üîß Bro Token ÈÖçÁΩÆËÑöÊú¨Â∑≤Âä†ËΩΩÔºÅ');
    console.log('üîß ÂÖ®Â±ÄÂáΩÊï∞Â∑≤Êö¥Èú≤Ôºö');
    console.log('   - window.getBroConfig');
    console.log('   - window.testProverConnection');

    // ËÑöÊú¨Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®ÊµãËØïProverËøûÊé•
    setTimeout(() => {
        testProverConnection();
    }, 1000);

})();